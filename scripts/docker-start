#!/bin/bash
set -eo pipefail
trap "exit 0" 2 15
function run_cmd {
  exec $*
}

function main {
  local cmd="$@"
  if [ -z "$cmd" ]; then
    cmd=(
      "/usr/bin/supervisord"
      "-c /etc/supervisor/supervisord.conf"
      )
  fi
  test -d "$SB_DATA" || mkdir -p "$SB_DATA"

  cd "$SB_HOME"
  git checkout $SICKRAGE_CHANNEL
  git pull

  dockerize=(
    "dockerize" 
    "-template /templates/config.ini.tpl:$SB_DATA/config.ini"
    "true"
    )
  if [ ! -f "$SB_DATA/config.ini" ]; then
    dockerize \
      -template /templates/config.ini.tpl:$SB_DATA/config.ini \
      echo "==> Writing $SB_DATA/config.ini from /templates/config.ini.tpl"
  fi
  run_cmd "${cmd[@]}"
}

main "$@"
exit 0